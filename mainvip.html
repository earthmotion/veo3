<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEO 3 UNLIMITED App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .dark {
            --bg-color: #000000;
            --text-color: #e5e7eb;
            --card-bg: #111827;
            --border-color: #374151;
            --input-bg: #1f2937;
        }
        /* Custom styles for select dropdown options in dark mode */
        select option {
            background-color: #1f2937;
            color: #e5e7eb;
        }
    </style>
</head>
<body class="dark bg-black text-gray-100 min-h-screen">

    <div class="mx-auto max-w-6xl p-4 sm:p-6 space-y-6">
        <header class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">VEO 3 UNLIMITED</h1>
                <p class="text-sm text-gray-400">Karya anda tercipta melalui sentuhan kreativitas dan teknologi AI</p>
            </div>
        </header>

        <div class="bg-gray-900 border border-gray-800 rounded-2xl shadow-sm">
            <div class="p-6">
                <h3 class="text-lg font-semibold tracking-tight">Configuration</h3>
                <p class="text-sm text-gray-400">Enter your video parameters</p>
            </div>
            <div class="p-6 pt-0 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <!-- Tabs -->
                    <div class="bg-gray-800 p-1 rounded-md grid grid-cols-2 text-gray-400">
                        <button id="tab-text" class="px-3 py-1.5 text-sm font-medium rounded-sm bg-gray-900 text-gray-50 shadow-sm">Text → Video</button>
                        <button id="tab-image" class="px-3 py-1.5 text-sm font-medium rounded-sm">Image → Video</button>
                    </div>
                    <!-- Text Content -->
                    <div id="content-text" class="pt-4">
                        <div class="space-y-2">
                            <label for="prompt-text" class="text-sm font-medium">Prompt</label>
                            <textarea id="prompt-text" rows="5" class="flex min-h-[80px] w-full rounded-md border border-gray-800 bg-transparent px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300" placeholder="Cyberpunk city at night with neon rain…">A majestic lion roaring on a rocky outcrop at sunset</textarea>
                            <p class="text-xs text-gray-400">Describe the scene for the video</p>
                        </div>
                    </div>
                    <!-- Image Content -->
                    <div id="content-image" class="pt-4 hidden">
                        <div class="space-y-4">
                            <div class="space-y-2">
                                <label for="prompt-img" class="text-sm font-medium">Prompt (optional)</label>
                                <textarea id="prompt-img" rows="3" class="flex min-h-[80px] w-full rounded-md border border-gray-800 bg-transparent px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300" placeholder="Pan from left to right across the skyline…"></textarea>
                                <p class="text-xs text-gray-400">Additional guidance for the scene</p>
                            </div>
                            <div class="space-y-2">
                                <label for="img-urls" class="text-sm font-medium">Image URLs</label>
                                <textarea id="img-urls" rows="5" class="flex min-h-[80px] w-full rounded-md border border-gray-800 bg-transparent px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300" placeholder="https://placehold.co/600x400/000000/FFFFFF?text=Image+1&#10;https://placehold.co/600x400/FFFFFF/000000?text=Image+2"></textarea>
                                <p class="text-xs text-gray-400">One URL per line. Order matters.</p>
                            </div>
                            <div id="image-previews" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="quality" class="text-sm font-medium text-white">Quality</label>
                            <select id="quality" class="flex h-10 w-full items-center justify-between rounded-md border border-gray-700 bg-white text-black px-3 py-2 text-sm">
                                <option value="480p">480p</option>
                                <option value="720p" selected>720p</option>
                                <option value="1080p">1080p</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label for="model" class="text-sm font-medium text-white">Model</label>
                            <select id="model" class="flex h-10 w-full items-center justify-between rounded-md border border-gray-700 bg-white text-black px-3 py-2 text-sm">
                                <option value="veo-3-fast">Veo 3 Fast</option>
                                <option value="veo-3">Veo 3</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 pt-2">
                        <button id="generate-btn" class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium rounded-lg h-10 px-5 py-2 gap-2 bg-gray-50 text-gray-900 hover:bg-gray-200">
                            <i data-lucide="video" class="h-4 w-4"></i> Generate
                        </button>
                        <button id="cancel-btn" class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium rounded-lg h-10 px-4 py-2 gap-2 bg-gray-800 text-gray-50 hover:bg-gray-700" disabled>
                            <i data-lucide="circle-stop" class="h-4 w-4"></i> Cancel
                        </button>
                    </div>
                    <div class="rounded-xl border border-yellow-500/30 bg-yellow-500/10 p-3 text-xs text-yellow-300 mt-auto">
                        <p class="font-medium mb-1">Action Required: Network Proxy</p>
                        <p>
                            This app uses a public proxy. If you see network errors, please
                            <a href="https://cors-anywhere.herokuapp.com/" target="_blank" rel="noopener noreferrer" class="underline font-semibold">
                                visit the proxy activation page
                            </a>, click the button to request access, and then try generating again.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-gray-900 border border-gray-800 rounded-2xl shadow-sm">
                <div class="p-6">
                    <h3 class="text-lg font-semibold tracking-tight">Video Preview</h3>
                    <p class="text-sm text-gray-400">Menampilkan cuplikan hasil generated video anda.</p>
                </div>
                <div id="video-previews" class="p-6 pt-0 space-y-4">
                    <div class="text-sm text-gray-500 h-60 flex items-center justify-center bg-gray-800/50 rounded-2xl">
                        Your videos will appear here.
                    </div>
                </div>
                 <div id="error-container" class="p-6 pt-0"></div>
            </div>

            <div class="bg-gray-900 border border-gray-800 rounded-2xl shadow-sm">
                <div class="p-6">
                    <h3 class="text-lg font-semibold tracking-tight">Status Proses</h3>
                    <p class="text-sm text-gray-400">Perkembangan pembuatan video secara real-time</p>
                </div>
                <div class="p-6 pt-0">
                    <div id="status-display" class="flex flex-col items-center text-center space-y-4 pt-4">
                        <div id="status-icon"><i data-lucide="info" class="h-12 w-12 text-gray-500"></i></div>
                        <p id="status-text" class="font-medium text-lg h-6">Siap untuk memulai</p>
                        <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                            <div id="progress-bar" class="h-3 rounded-full bg-gray-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div id="log-container" class="text-xs font-mono space-y-1 w-full text-left bg-gray-800/50 p-3 rounded-lg h-28 overflow-auto">
                            <div class="text-gray-400">Log akan tampil di sini…</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-xs text-gray-400 text-center py-4">
            © 2024 — VEO 3 Studio • Built with React & Tailwind. Powered by Arif Kurniawan.
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // CORS Anywhere Script
        (function() {
            var cors_api_host = 'cors-anywhere.herokuapp.com';
            var cors_api_url = 'https://' + cors_api_host + '/';
            var slice = [].slice;
            var origin = window.location.protocol + '//' + window.location.host;
            var open = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function() {
                var args = slice.call(arguments);
                var targetOrigin = /^https?:\/\/([^\/]+)/i.exec(args[1]);
                if (targetOrigin && targetOrigin[0].toLowerCase() !== origin &&
                    targetOrigin[1] !== cors_api_host) {
                    args[1] = cors_api_url + args[1];
                }
                return open.apply(this, args);
            };
        })();

        // Application Logic
        document.addEventListener('DOMContentLoaded', () => {
            const hardcodedApiKey = "fgsiapi-1e3e18a6-6d";
            let currentTab = 'text';
            let busy = false;
            let clientRef = null;

            // DOM Elements
            const tabText = document.getElementById('tab-text');
            const tabImage = document.getElementById('tab-image');
            const contentText = document.getElementById('content-text');
            const contentImage = document.getElementById('content-image');
            const generateBtn = document.getElementById('generate-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const logContainer = document.getElementById('log-container');
            const statusIcon = document.getElementById('status-icon');
            const statusText = document.getElementById('status-text');
            const progressBar = document.getElementById('progress-bar');
            const videoPreviews = document.getElementById('video-previews');
            const errorContainer = document.getElementById('error-container');
            const imgUrlsTextarea = document.getElementById('img-urls');
            const imagePreviewsContainer = document.getElementById('image-previews');

            // --- API Client Class ---
            class LunaAI {
              constructor(debug = false) {
                this.debug = debug;
                this.bypassUrl = "https://fgsi.koyeb.app/api/tools/bypasscf/v5";
                this.createUrl = "https://aiarticle.erweima.ai/api/v1/secondary-page/api/create";
                this.statusUrl = "https://aiarticle.erweima.ai/api/v1/secondary-page/api/";
                this.sitekey = "0x4AAAAAAAdJZmNxW54o-Gvd"; 
                this._interval = null;
              }

              cancel() {
                if (this._interval) {
                  clearInterval(this._interval);
                  this._interval = null;
                }
              }

              async bypassCF(url, apikey) {
                const res = await axios.get(this.bypassUrl, {
                  params: { apikey, url, sitekey: this.sitekey, mode: "turnstile-min" },
                  headers: { 'x-requested-with': 'XMLHttpRequest' }
                });
                return res?.data?.data?.token;
              }

              async createVideo(token, payload) {
                const headers = {
                  'Content-Type': 'application/json',
                  'verify': token,
                  'uniqueid': window.btoa(String(Date.now())),
                  'x-requested-with': 'XMLHttpRequest'
                };
                const res = await axios.post(this.createUrl, payload, { headers });
                const recordId = res?.data?.data?.recordId;
                if (recordId) return recordId;
                throw new Error(`API returned an error: ${res?.data?.msg || JSON.stringify(res.data)}`);
              }

              async checkStatus(recordId) {
                const res = await axios.get(`${this.statusUrl}${recordId}`, { headers: { 'x-requested-with': 'XMLHttpRequest' } });
                return res?.data?.data;
              }

              run(options) {
                return new Promise(async (resolve, reject) => {
                  try {
                    const token = await this.bypassCF("https://lunaai.video/features/v3-fast", options.apikey);
                    if (!token) return reject(new Error("Bypass token failed."));
                    
                    const payload = { ...options };
                    delete payload.onPoll;
                    delete payload.apikey;

                    const recordId = await this.createVideo(token, payload);
                    
                    this._interval = setInterval(async () => {
                      try {
                        const data = await this.checkStatus(recordId);
                        options.onPoll?.(data);
                        if (data?.state === "success" && data?.completeData) {
                          this.cancel();
                          resolve(JSON.parse(data.completeData));
                        } else if (data?.failCode || data?.failMsg) {
                          this.cancel();
                          reject(new Error(`[Failed] ${data.failCode || ""} ${data.failMsg || ""}`));
                        }
                      } catch (err) {
                        this.cancel();
                        reject(err);
                      }
                    }, 5000);
                  } catch (err) {
                    reject(err);
                  }
                });
              }
            }
            
            function guessVideoUrl(obj) {
                if (!obj) return undefined;
                const candidates = [obj.video_url, obj.videoUrl, obj.url, obj.downloadUrl, obj?.video?.url];
                for (const c of candidates) {
                    if (typeof c === "string" && c.startsWith("http")) return c.replace(/_watermarked/g, '');
                }
                return undefined;
            }

            // --- UI Update Functions ---
            function pushLog(line) {
                if (logContainer.children.length === 1 && logContainer.children[0].innerText.includes('Log akan tampil')) {
                    logContainer.innerHTML = '';
                }
                const logEntry = document.createElement('div');
                logEntry.className = 'whitespace-pre-wrap break-all';
                logEntry.textContent = `${new Date().toLocaleTimeString()} — ${line}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            function updateStatus(text, iconName, progress, colorClass) {
                statusText.textContent = text;
                statusIcon.innerHTML = `<i data-lucide="${iconName}" class="h-12 w-12 ${colorClass || ''}"></i>`;
                if (iconName === 'loader-2') statusIcon.firstElementChild.classList.add('animate-spin');
                lucide.createIcons();
                progressBar.style.width = `${progress}%`;
                progressBar.className = `h-3 rounded-full transition-all duration-500 ${colorClass || 'bg-gray-500'}`;
            }

            function resetUI() {
                busy = false;
                generateBtn.disabled = false;
                cancelBtn.disabled = true;
                generateBtn.innerHTML = '<i data-lucide="video" class="h-4 w-4"></i> Generate';
                lucide.createIcons();
            }

            function displayError(message) {
                errorContainer.innerHTML = `<div class="rounded-xl border border-red-500/30 p-3 text-sm text-red-400 bg-red-500/10">${message}</div>`;
            }
            
            function displayVideos(urls) {
                if (urls.length === 0) {
                    videoPreviews.innerHTML = `<div class="text-sm text-gray-500 h-60 flex items-center justify-center bg-gray-800/50 rounded-2xl">Your videos will appear here.</div>`;
                    return;
                }
                
                videoPreviews.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>`;
                const grid = videoPreviews.firstElementChild;

                urls.forEach((url, index) => {
                    const videoContainer = document.createElement('div');
                    videoContainer.className = 'space-y-2';
                    videoContainer.innerHTML = `
                        <video src="${url}" controls class="w-full rounded-2xl shadow-lg bg-black aspect-video"></video>
                        <button id="download-btn-${index}" class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium rounded-lg h-10 px-4 py-2 w-full gap-2 bg-gray-800 text-gray-50 hover:bg-gray-700">
                            <i data-lucide="download" class="h-4 w-4"></i> Download Video ${index + 1}
                        </button>
                    `;
                    grid.appendChild(videoContainer);
                    document.getElementById(`download-btn-${index}`).addEventListener('click', () => handleDownload(url, index));
                });
                lucide.createIcons();
            }

            // --- Event Handlers ---
            tabText.addEventListener('click', () => {
                currentTab = 'text';
                tabText.classList.add('bg-gray-900', 'text-gray-50', 'shadow-sm');
                tabImage.classList.remove('bg-gray-900', 'text-gray-50', 'shadow-sm');
                contentText.classList.remove('hidden');
                contentImage.classList.add('hidden');
            });

            tabImage.addEventListener('click', () => {
                currentTab = 'image';
                tabImage.classList.add('bg-gray-900', 'text-gray-50', 'shadow-sm');
                tabText.classList.remove('bg-gray-900', 'text-gray-50', 'shadow-sm');
                contentImage.classList.remove('hidden');
                contentText.classList.add('hidden');
            });
            
            imgUrlsTextarea.addEventListener('input', () => {
                const urls = imgUrlsTextarea.value.split(/\n|,/).map(s => s.trim()).filter(Boolean);
                imagePreviewsContainer.innerHTML = '';
                urls.forEach(url => {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'rounded-xl overflow-hidden border bg-muted/30';
                    previewDiv.innerHTML = `<img src="${url}" alt="Image preview" class="w-full h-28 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/150x150/EEE/333?text=Invalid';"/>`;
                    imagePreviewsContainer.appendChild(previewDiv);
                });
            });

            generateBtn.addEventListener('click', async () => {
                busy = true;
                generateBtn.disabled = true;
                cancelBtn.disabled = false;
                generateBtn.innerHTML = '<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i> Generate';
                lucide.createIcons();

                logContainer.innerHTML = '';
                errorContainer.innerHTML = '';
                videoPreviews.innerHTML = `<div class="text-sm text-gray-500 h-60 flex items-center justify-center bg-gray-800/50 rounded-2xl">Generating videos...</div>`;
                
                clientRef = new LunaAI(true);
                let videoUrls = [];

                try {
                    for (let i = 0; i < 2; i++) {
                        pushLog(`Generating video ${i + 1} of 2...`);
                        const res = await clientRef.run({
                            apikey: hardcodedApiKey,
                            prompt: document.getElementById(currentTab === 'text' ? 'prompt-text' : 'prompt-img').value,
                            imgUrls: currentTab === 'image' ? imgUrlsTextarea.value.split(/\n|,/).map(s => s.trim()).filter(Boolean) : [],
                            quality: document.getElementById('quality').value,
                            model: document.getElementById('model').value,
                            duration: 8,
                            aspectRatio: "16:9",
                            vipFlag: true,
                            secondaryPageId: 1946, // FIX: Added missing parameter
                            onPoll: (data) => {
                                const pct = data?.percent || data?.progress;
                                const st = data?.state || data?.status;
                                const baseProgress = i * 50;
                                const currentProgress = (pct || 0) / 2;
                                updateStatus(`Status (Video ${i + 1}): ${st ?? "…"}`, 'loader-2', baseProgress + currentProgress, 'text-blue-500');
                                pushLog(`Status (Video ${i + 1}): ${st ?? "…"}${pct ? ` (${pct}%)` : ""}`);
                            },
                        });
                        const url = guessVideoUrl(res);
                        if (url) {
                            videoUrls.push(url);
                            displayVideos(videoUrls);
                            pushLog(`✅ Success — video ${i + 1} generated.`);
                        } else {
                            pushLog(`⚠️ Failed to get URL for video ${i + 1}.`);
                        }
                    }
                    updateStatus('Video Berhasil Dibuat!', 'circle-check', 100, 'text-green-500');
                } catch (e) {
                    console.error(e);
                    const errorMessage = `${e.message || String(e)} This can be caused by two main issues: 1) The CORS proxy needs activation. Please visit cors-anywhere.herokuapp.com, request access, and try again. 2) Your API Key may be invalid or expired.`;
                    displayError(errorMessage);
                    updateStatus('Terjadi Kesalahan', 'circle-x', 100, 'text-red-500');
                    pushLog(`❌ Error: ${e.message}`);
                } finally {
                    resetUI();
                }
            });

            cancelBtn.addEventListener('click', () => {
                clientRef?.cancel();
                resetUI();
                updateStatus('Dibatalkan', 'info', 0, 'text-gray-500');
                pushLog("⏹️ Cancelled by user.");
            });
            
            async function handleDownload(url, index) {
                const downloadBtn = document.getElementById(`download-btn-${index}`);
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = '<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i> Downloading...';
                lucide.createIcons();
                errorContainer.innerHTML = '';

                try {
                    const response = await fetch(`https://cors-anywhere.herokuapp.com/${url}`);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    const blob = await response.blob();
                    const objectUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = objectUrl;
                    link.download = `veo3-unlimited-video-${index + 1}.mp4`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(objectUrl);
                } catch (err) {
                    console.error('Download failed:', err);
                    displayError("Download failed. Please try right-clicking the video and selecting 'Save video as...'. This may be due to a network or proxy issue.");
                } finally {
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = `<i data-lucide="download" class="h-4 w-4"></i> Download Video ${index + 1}`;
                    lucide.createIcons();
                }
            }
        });
    </script>
</body>
</html>
